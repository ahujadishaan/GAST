# Godot Android Streaming Texture (GAST) Plugin

This is a collection of Godot Android plugins that leverage
[Godot's support for OpenGL external textures](https://github.com/godotengine/godot/pull/36342)
to enable rendering and interaction with Android views in a Godot project's scenegraph.

**Note:** The plugins are only supported on the Godot **3.2.x** branch, starting with **version 3.2.2**.

## Plugins

- [GAST-Video](video/README.md)
- [GAST-WebView](webview/README.md)

## Architecture

The GAST plugin is written in C++ and Kotlin.

The Kotlin layer leverages the [Godot Android Plugin framework](https://docs.godotengine.org/en/stable/tutorials/plugins/android/android_plugin.html)
to integrate with a Godot Android application. It provides the public APIs for Android clients to access the plugin core functionality in order to render, interact with and manipulate content generated by the Android View system in Godot’s scenegrah.

The core functionality is written in C++. It leverages the [Godot GDNative C++ bindings](https://github.com/godotengine/godot-cpp)
in order to access and use the [GDNative API](https://godotengine.org/article/dlscript-here).
Through that API, it’s able to access at runtime the project scenegraph and manipulate it by adding,
updating and/or removing Godot nodes and/or resources.

### GastNode

This is the element in the scenegraph responsible for rendering and supporting interaction with an
Android view.

#### Structure

![GastNode structure](docs/imgs/gast_node_structure.png)

A GastNode is made of the following Godot nodes and resources:

1. [StaticBody node](https://docs.godotengine.org/en/stable/classes/class_staticbody.html) as the
root node, which allows the GastNode to detect collision events (if enabled by the user).
2. A StaticBody node [requires](https://docs.godotengine.org/en/stable/tutorials/physics/physics_introduction.html#collision-shapes)
a [Shape resource](https://docs.godotengine.org/en/stable/classes/class_shape.html) to define the
object’s collision bounds. For the GastNode, we’re using a [BoxShape resource](https://docs.godotengine.org/en/stable/classes/class_boxshape.html)
(within a [CollisionShape node](https://docs.godotengine.org/en/stable/classes/class_collisionshape.html))
since we’re setting the collision bounds for a quad in 3D space.
3. Since our GastNode is ultimately a quad in 3D space, we make use of Godot’s [QuadMesh resource](https://docs.godotengine.org/en/stable/classes/class_quadmesh.html)
(within a [MeshInstance node](https://docs.godotengine.org/en/stable/classes/class_meshinstance.html))
to render the GastNode.

Once a GastNode is created, the client gains the ability to retrieve a [Surface](https://developer.android.com/reference/android/view/Surface)
instance via the [GastNode#bindSurface()](core/src/main/java/org/godotengine/plugin/gast/GastNode.kt#L81) API.
The Surface instance can be used as an output destination onto which Android Views, images or videos
can be rendered. This is the process used by the [GAST-Video](video/README.md)
and [GAST-WebView](webview/README.md) plugins.

#### Input Handling

Using the [GastInputListener interface](core/src/main/java/org/godotengine/plugin/gast/input/GastInputListener.kt)
via the [GastManager#registerGastInputListener(...)](core/src/main/java/org/godotengine/plugin/gast/GastManager.kt#L107)
and [GastManager#unregisterGastInputListener(...)](core/src/main/java/org/godotengine/plugin/gast/GastManager.kt#L127)
methods, the GastManager instance relays *interaction* events from the generated node(s) to the
client. This provides the client with enough information to generate and feed [Android MotionEvent](https://developer.android.com/reference/android/view/MotionEvent)
events to the Android view.

Two types of events are supported:

##### Input Events

The plugin uses the [Godot Input API](https://docs.godotengine.org/en/stable/tutorials/inputs/inputevent.html)
to subscribe to dispatched [input action events](https://docs.godotengine.org/en/stable/classes/class_inputeventaction.html)
(e.g: button press). It listens for the events registered by the client via the
[GastInputListener#getInputActionsToMonitor()](core/src/main/java/org/godotengine/plugin/gast/input/GastInputListener.kt#L48)
method, and notifies the client accordingly via the [GastInputListener#onMainInputAction(...)](core/src/main/java/org/godotengine/plugin/gast/input/GastInputListener.kt#L57) callback.


##### Collision Events

Godot’s [Physics API](https://docs.godotengine.org/en/stable/tutorials/physics/physics_introduction.html)
is used in order to detect collision events between the GastNode and a [ray cast](https://docs.godotengine.org/en/stable/classes/class_raycast.html)
from the input pointer (in VR the input pointer consists of a tracked controller/hand).
This is used to provide support for detecting *click*, *hover* and *scroll* events targeted at the GastNode.

The client is then notified using the corresponding method:

- [GastInputListener#onMainInputHover(...)](core/src/main/java/org/godotengine/plugin/gast/input/GastInputListener.kt#L64) for hover events
- [GastInputListener#onMainInputPress(...)](core/src/main/java/org/godotengine/plugin/gast/input/GastInputListener.kt#L71) for click press events
- [GastInputListener#onMainInputRelease(...)](core/src/main/java/org/godotengine/plugin/gast/input/GastInputListener.kt#L78) for click release events
- [GastInputListener#onMainInputScroll(...)](core/src/main/java/org/godotengine/plugin/gast/input/GastInputListener.kt#L85) for scroll events

The notification includes the [nodepath](https://docs.godotengine.org/en/stable/classes/class_nodepath.html)
of the targeted Gast node, the [nodepath](https://docs.godotengine.org/en/stable/classes/class_nodepath.html)
of the colliding ray cast and information specific to the type of the event (e.g: hover location for
a hover event).

###### Collision Events Setup

A **couple of requirements must be followed** for the collision events handling to be properly set up.

1. The colliding raycast **must** belong to the **gast_ray_caster** [node group](https://docs.godotengine.org/en/stable/getting_started/step_by_step/scripting_continued.html#groups).
This allows to filter unwanted raycast collisions.
2. Since *click* and *scroll* events rely on additional input events (e.g: button press, joystick
tilt), the plugin monitors a set of [input action events](https://docs.godotengine.org/en/stable/classes/class_inputeventaction.html)
with the characteristics listed below. **It’s the responsibility** of the client to **declare
and register** the corresponding [input actions](https://docs.godotengine.org/en/stable/tutorials/inputs/inputevent.html?#actions)
in the Godot project.
   - The monitored input action prefix is generated by replacing the slash character (“**/**”)
   in the colliding raycast’s [nodepath](https://docs.godotengine.org/en/stable/classes/class_nodepath.html)
   with the underscore character (“**_**”).
     - E.g: input action prefix for a [RayCast](https://docs.godotengine.org/en/stable/classes/class_raycast.html)
     node with path **/root/Main/Controller/RayCast** would be **_root_Main_Controller_RayCast**
   - There is one input action per raycast for click events. It’s generated by appending the
   “**_click**” suffix to the input action prefix generated as described above.
     - E.g: click action event for a [RayCast](https://docs.godotengine.org/en/stable/classes/class_raycast.html)
     node with path **/root/Main/Controller/RayCast** would be **_root_Main_Controller_RayCast_click**
   - There are two input actions per raycast for horizontal scroll events. They are generated by
   appending “**_left_scroll**” for the left scroll events and “**_right_scroll**” for the right
   scroll events.
     - E.g: For a [RayCast](https://docs.godotengine.org/en/stable/classes/class_raycast.html) node with path **/root/Main/Controller/RayCast**
       - Left scroll => **_root_Main_Controller_RayCast_left_scroll**
       - Right scroll => **_root_Main_Controller_RayCast_right_scroll**
   - There are two input actions per raycast for vertical scroll events. They are generated by
   appending “**_up_scroll**” for the up scroll events and “**_down_scroll**” for the down scroll
   events.
     - E.g: For a [RayCast](https://docs.godotengine.org/en/stable/classes/class_raycast.html) node
     with path **/root/Main/Controller/RayCast**
       - Up scroll => **_root_Main_Controller_RayCast_up_scroll**
       - Down scroll => **_root_Main_Controller_RayCast_down_scroll**

## Performance Considerations

The GAST plugin attempts to recycle GastNodes as much as possible, only creating new ones if the
pool is empty or exhausted. This allows to keep a lid on the number of generated OpenGL external
textures.

